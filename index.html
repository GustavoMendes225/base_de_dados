<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard Principal</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<style>

:root {
  --azul-escuro: #182C4B;
  --verde-claro: #00BFAE;
  --cinza-claro: #F4F6F9;
  --cinza-escuro: #4A4A4A;
  --branco: #FFFFFF;
  --amarelo: #F39C12;
  --vermelho: #E74C3C;
  --verde-secundario: #2ECC71;
  --roxo: #9b59b6; 
  --laranja-alerta: #FF7043; 
  --verde-receita: #4CAF50; 
  --azul-vip: #03A9F4; 
  
  /* Cores para os novos Gráficos */
  --cor-principal-a: #182C4B; /* Azul Escuro */
  --cor-principal-b: #00BFAE; /* Verde Claro */
  --cor-alerta-alta: #E74C3C; 
  --cor-oportunidade: #F39C12; 
  --cor-conversao: #4CAF50; 
}

/* Reset */
* { box-sizing: border-box; font-family: 'Poppins', sans-serif; margin: 0; padding: 0; }
html, body { height: 100%; }

/* Animação do Loader */
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/* Loader */
#loader {
  position: fixed; top:0; left:0; width:100%; height:100%; background: var(--branco);
  display:flex; justify-content:center; align-items:center; flex-direction:column; z-index:2000;
}
.loader-text { margin-top:15px; font-weight:500; color: var(--azul-escuro); }
.loader-icon { 
    width:50px; height:50px; 
    animation: spin 1.2s linear infinite; 
}

/* Navbar */
.navbar {
  height:60px; background-color: var(--azul-escuro); color: var(--branco);
  display:flex; justify-content:space-between; align-items:center; padding:0 20px;
  position:fixed; width:100%; top:0; z-index:1000; box-shadow:0 2px 5px rgba(0,0,0,0.1);
  font-weight: 600;
}
.navbar .btn-toggle {
  background-color: var(--azul-escuro); border:none; padding:8px 15px; color: var(--branco);
  border-radius:5px; cursor:pointer; font-size:24px; transition:0.3s;
}
.navbar .btn-sair {
  background-color: var(--azul-escuro); border:solid 1px; padding:8px 15px; color: var(--branco);
  border-radius:5px; cursor:pointer; font-size:12px; transition:0.3s;
}
.navbar .btn-sair:hover, .navbar .btn-toggle:hover { opacity:0.9; }
.navbar .btn-toggle { 
    display:flex; align-items:center; justify-content:center; 
    transition: transform 0.3s ease; /* CORREÇÃO AQUI para a animação da rotação */
}

/* Sidebar (AQUI ESTÃO AS ALTERAÇÕES SOLICITADAS) */
.sidebar {
  width:250px; background-color: var(--cinza-claro); padding:20px;
  position:fixed; top:60px; left:0; height:calc(100% - 60px); overflow-y:auto;
  box-shadow:2px 0 12px rgba(0,0,0,0.2);
  transition:left 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  z-index:999;
}
.sidebar-section { margin-bottom:25px; }
.sidebar-section h4 { 
    font-size:13px; text-transform:uppercase; color: var(--cinza-escuro); 
    margin-bottom:10px; letter-spacing:0.5px; 
}
.sidebar a {
  display:flex; align-items:center; text-decoration:none; color: var(--azul-escuro);
  padding:10px; border-radius:5px; margin-bottom:5px; font-weight:500;
  transition: all 0.3s ease, box-shadow 0.3s ease, transform 0.3s ease;
  position: relative;
}
.sidebar a .icon { margin-right:10px; transition: transform 0.3s ease; }
.sidebar a:hover {
  background-color: var(--verde-claro); color: var(--branco);
  transform: translateX(8px); box-shadow: 2px 4px 10px rgba(0,0,0,0.15);
}
.sidebar a.active {
  background-color: var(--azul-escuro); color: var(--branco);
  font-weight:600; border-left:4px solid var(--verde-claro);
  box-shadow: 2px 4px 10px rgba(0,0,0,0.15); 
  transform: translateX(0);
}
.sidebar.closed { left:-260px; }


/* Main container */
.main-container {
  margin-left:250px; 
  padding:80px 20px 80px 20px;
  min-height: calc(100vh - 60px); 
  background-color: var(--cinza-claro); 
  transition: margin-left 0.4s cubic-bezier(0.4, 0, 0.2, 1), transform 0.5s, opacity 0.5s;
  opacity:0; transform:translateY(20px);
}
/* Sidebar recolhida */
.main-container.closed { margin-left:0; }

/* Content Layout (Dashboard Grid) */
.dashboard-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}
/* KPI Cards (Estilos Omitidos para concisão...) */
.kpi-card { background-color: var(--branco); padding: 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); border-left: 5px solid var(--azul-escuro); }
.kpi-card-title { font-size: 14px; color: var(--cinza-escuro); text-transform: uppercase; margin-bottom: 5px; }
.kpi-card-value { font-size: 28px; font-weight: 700; color: var(--azul-escuro); }
.kpi-card-change { font-size: 12px; margin-top: 5px; font-weight: 500; }
.positive { color: var(--verde-secundario); }

/* Chart Area */
.chart-area {
    background-color: var(--branco);
    padding: 30px;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    text-align: center;
    margin-bottom: 20px; 
}
.chart-area h2 {
    color: var(--azul-escuro);
    margin-bottom: 20px;
    border-bottom: 2px solid var(--verde-claro);
    padding-bottom: 10px;
    font-size: 20px;
}
.chart-placeholder {
    height: 400px;
    background-color: var(--cinza-claro);
    border: 1px dashed #ccc;
    display: flex;
    justify-content: center;
    align-items: center;
    color: var(--cinza-escuro);
    font-style: italic;
    border-radius: 5px;
    font-weight: 600;
}

/* Layout para os gráficos em linha (Funil + Status) */
.chart-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}
.chart-row .chart-area {
    margin-bottom: 0;
}

/* Footer fixo */
.footer {
  position: fixed; bottom:0; width:100%; height:60px;
  text-align:center; padding:20px 0; background-color: var(--cinza-claro); border-top:1px solid #ddd;
  z-index: 990;
}

/* Responsividade */
@media screen and (max-width:768px){
  .sidebar { left:-260px; }
  .sidebar.open { left:0; }
  .main-container { margin-left:0; padding-bottom:80px; padding-top: 80px; }
  .dashboard-grid, .chart-row { grid-template-columns: 1fr; }
}

</style>
</head>

<body>
<div id="loader">
  <svg class="loader-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50">
    <path d="M25 0 A25 25 0 1 1 24.99 0" stroke="var(--verde-claro)" stroke-width="5" fill="none"/>
  </svg>
  <div class="loader-text">Carregando Dashboard...</div>
</div>

<div class="navbar">
  <button class="btn-toggle" onclick="toggleSidebar()">☰</button>
  Vinde Investimentos
  <button class="btn-sair" onclick="window.location.href='login.html'">Sair</button>
</div>

<div class="sidebar" id="sidebar">
  <div class="sidebar-section">
    <h4>Operações</h4>
    <a href="#" class="active"><span class="icon">></span> Dashboard Principal</a>
    <a href="base_de_dados.html"><span class="icon">></span> Base de Dados</a>
  </div>
</div>

<div class="main-container" id="mainContainer">
    <h1>Visão Estratégica & Oportunidades</h1>
    <p style="margin-bottom: 20px; color: var(--cinza-escuro);">Insights acionáveis sobre concentração de risco, potencial de receita e taxas de conversão da base.</p>

    <div class="dashboard-grid">
        
        <div class="kpi-card">
            <div class="kpi-card-title">AUM TOTAL (CUSTÓDIA)</div>
            <div class="kpi-card-value" id="kpiAUMTotal">R$ 0,00</div>
            <div class="kpi-card-change positive" id="kpiAUMChange">Carregando...</div>
        </div>
        
        <div class="kpi-card" style="border-left-color: var(--verde-receita);">
            <div class="kpi-card-title">RECEITA ANUAL PROJETADA</div>
            <div class="kpi-card-value" id="kpiReceitaMensal">R$ 0,00</div>
            <div class="kpi-card-change positive" id="kpiReceitaChange">Baseado em Fee Médio.</div>
        </div>
        
        <div class="kpi-card" style="border-left-color: var(--verde-claro);">
            <div class="kpi-card-title">TOTAL DE CLIENTES</div>
            <div class="kpi-card-value" id="kpiTotalClientes">0</div>
            <div class="kpi-card-change positive" id="kpiClientesChange">Dados carregados da base.</div>
        </div>

        <div class="kpi-card" style="border-left-color: var(--amarelo);">
            <div class="kpi-card-title">FEE MÉDIO PONDERADO</div>
            <div class="kpi-card-value" id="kpiFeeMedio">0.00%</div>
            <div class="kpi-card-change neutral" id="kpiFeeChange">Calculado pelo AUM.</div>
        </div>

        <div class="kpi-card" style="border-left-color: var(--roxo);">
            <div class="kpi-card-title">TICKET MÉDIO POR CLIENTE</div>
            <div class="kpi-card-value" id="kpiTicketMedio">R$ 0,00</div>
            <div class="kpi-card-change neutral" id="kpiTicketChange">Calculado pelo AUM total.</div>
        </div>
        
        </div>

    <div class="chart-area">
        <h2> Análise de Risco de Concentração (AUM por Corretora)</h2>
        <div style="max-width: 450px; margin: 0 auto; height: 400px; display: flex; align-items: center; justify-content: center;">
            <canvas id="aumCorretoraChart"></canvas>
            <div id="corretoraNoDataMessage" class="chart-placeholder" style="display: none; height: 100%; width: 100%;">
                 <p>Sem dados de AUM ou Corretora (Verifique a coluna 'Corretora' na Base de Dados).</p>
            </div>
        </div>
    </div>
    
    <div class="chart-row">
        <div class="chart-area">
            <h2> Oportunidade: Fee Médio por Faixa de AUM</h2>
             <div style="max-width: 100%; margin: 0 auto; height: 400px; display: flex; align-items: center; justify-content: center;">
                <canvas id="feeAumChart"></canvas>
                <div id="feeNoDataMessage" class="chart-placeholder" style="display: none; height: 100%; width: 100%;">
                    <p>Sem dados de Fee ou AUM para análise de oportunidade.</p>
                </div>
            </div>
        </div>
        
        <div class="chart-area">
            <h2> Taxas de Conversão Imediatas (Funil %$)</h2>
            <div style="max-width: 100%; margin: 0 auto; height: 400px; display: flex; align-items: center; justify-content: center;">
                <canvas id="conversionRatesChart"></canvas>
                <div id="ratesNoDataMessage" class="chart-placeholder" style="display: none; height: 100%; width: 100%;">
                    <p>Sem dados de Assinatura/Custódia para calcular as taxas de conversão.</p>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="footer">© 2025 Vinde Investimentos</div>

<script>
let clientsData = [];
let chartInstances = {}; // Objeto para gerenciar todas as instâncias de gráficos

const formatCurrency = (value) => {
    const num = parseFloat(value) || 0;
    return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(num);
};

const formatPercentage = (value) => {
    const num = parseFloat(value) || 0;
    return (num * 100).toFixed(1) + '%';
};

// --- FUNÇÃO CENTRAL DE CÁLCULO DE KPIS ---
function calculateKPIs(data) {
    if (data.length === 0) {
        return { AUMTotal: 0, ReceitaAnual: 0, FeeMedio: 0, TicketMedio: 0, ClientesCount: 0, AssinadosCount: 0, CustodiaCount: 0 };
    }
    
    let totalAUMCustodia = 0;
    let totalFeeAnual = 0;
    let clientesCount = 0;
    let assinadosCount = 0;
    let custodiaCount = 0;
    
    data.forEach(client => {
        if (!client.CodigoConta) return; 

        const aum = parseFloat(client.AUM) || 0;
        const fee = parseFloat(client.Fee) || 0;
        
        totalAUMCustodia += aum;
        totalFeeAnual += aum * fee; 
        clientesCount++;
        
        if (String(client.AssinouContrato).toLowerCase().includes('sim')) {
            assinadosCount++;
        }
        if (String(client.SubiuCorretora).toLowerCase().includes('sim')) {
             custodiaCount++;
        }
    });

    const feeMedioPonderado = totalAUMCustodia > 0 ? (totalFeeAnual / totalAUMCustodia) : 0;
    const ticketMedio = clientesCount > 0 ? (totalAUMCustodia / clientesCount) : 0;
    
    return {
        AUMTotal: totalAUMCustodia, ReceitaAnual: totalFeeAnual, FeeMedio: feeMedioPonderado,
        TicketMedio: ticketMedio, ClientesCount: clientesCount, AssinadosCount: assinadosCount,
        CustodiaCount: custodiaCount
    };
}

// --- GRÁFICO 1: AUM POR CORRETORA (RISCO DE CONCENTRAÇÃO) ---
function renderAUMCorretoraChart(data) {
    const corretoraData = {};
    data.forEach(client => {
        const aum = parseFloat(client.AUM) || 0;
        if (aum === 0) return;
        const corretora = String(client.Corretora || 'Não Informada').trim();
        corretoraData[corretora] = (corretoraData[corretora] || 0) + aum;
    });

    const labels = Object.keys(corretoraData).filter(key => corretoraData[key] > 0);
    const values = labels.map(key => corretoraData[key]);
    
    const canvas = document.getElementById('aumCorretoraChart');
    const noDataMessage = document.getElementById('corretoraNoDataMessage');
    
    if (values.length === 0) {
        canvas.style.display = 'none';
        noDataMessage.style.display = 'flex';
        if (chartInstances.aumCorretoraChart) chartInstances.aumCorretoraChart.destroy();
        return;
    }

    canvas.style.display = 'block';
    noDataMessage.style.display = 'none';

    if (chartInstances.aumCorretoraChart) chartInstances.aumCorretoraChart.destroy();
    
    chartInstances.aumCorretoraChart = new Chart(canvas, {
        type: 'pie',
        data: {
            labels: labels,
            datasets: [{
                data: values,
                backgroundColor: labels.map((_, i) => `hsl(${(i * 360 / labels.length)}, 70%, 50%)`),
                hoverOffset: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'right' },
                tooltip: {
                    callbacks: {
                        label: (context) => {
                            let label = context.label || '';
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = (context.parsed / total * 100).toFixed(1);
                            label += ': ' + formatCurrency(context.parsed) + ` (${percentage}%)`;
                            return label;
                        }
                    }
                },
            }
        }
    });
}


// --- GRÁFICO 2: FEE MÉDIO POR FAIXA DE AUM (OPORTUNIDADE) ---
function renderFeeAumChart(data) {
    const FAIIXAS = {
        '0 - 50K': { min: 0, max: 50000, AUMTotal: 0, FeeTotal: 0 },
        '50K - 250K': { min: 50001, max: 250000, AUMTotal: 0, FeeTotal: 0 },
        '250K - 1M': { min: 250001, max: 1000000, AUMTotal: 0, FeeTotal: 0 },
        '1M+': { min: 1000001, max: Infinity, AUMTotal: 0, FeeTotal: 0 }
    };

    let totalValid = 0;

    data.forEach(client => {
        const aum = parseFloat(client.AUM) || 0;
        const fee = parseFloat(client.Fee) || 0;
        if (aum === 0 || fee === 0) return;
        totalValid++;

        for (const faixa in FAIIXAS) {
            if (aum >= FAIIXAS[faixa].min && aum <= FAIIXAS[faixa].max) {
                FAIIXAS[faixa].AUMTotal += aum;
                FAIIXAS[faixa].FeeTotal += aum * fee;
                break;
            }
        }
    });

    const labels = Object.keys(FAIIXAS);
    const feeMedios = labels.map(faixa => {
        const f = FAIIXAS[faixa];
        return f.AUMTotal > 0 ? (f.FeeTotal / f.AUMTotal) : 0;
    });

    const canvas = document.getElementById('feeAumChart');
    const noDataMessage = document.getElementById('feeNoDataMessage');
    
    if (totalValid === 0) {
        canvas.style.display = 'none';
        noDataMessage.style.display = 'flex';
        if (chartInstances.feeAumChart) chartInstances.feeAumChart.destroy();
        return;
    }

    canvas.style.display = 'block';
    noDataMessage.style.display = 'none';
    
    if (chartInstances.feeAumChart) chartInstances.feeAumChart.destroy();

    chartInstances.feeAumChart = new Chart(canvas, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Fee Médio Ponderado',
                data: feeMedios.map(f => f * 100), // Exibir em porcentagem (0.5% -> 0.5)
                backgroundColor: (context) => {
                    // Destaca a faixa com menor Fee Médio (maior oportunidade de upsell)
                    const data = context.chart.data.datasets[0].data;
                    const minFee = Math.min(...data.filter(val => val > 0)); 
                    return context.parsed.y > 0 && context.parsed.y === minFee 
                        ? 'var(--cor-oportunidade)' 
                        : 'var(--cor-principal-a)';
                }
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: (context) => {
                             return `Fee Médio: ${context.parsed.y.toFixed(2)}%`;
                        }
                    }
                },
            },
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Fee Médio (%)'
                    },
                    ticks: {
                       callback: (value) => value + '%'
                    }
                }
            }
        }
    });
}

// --- GRÁFICO 3: TAXAS DE CONVERSÃO IMEDIATA (%) ---
function renderConversionRatesChart(kpis) {
    const { ClientesCount, AssinadosCount, CustodiaCount } = kpis;
    
    const taxaAssinatura = ClientesCount > 0 ? (AssinadosCount / ClientesCount) : 0;
    const taxaCustodia = AssinadosCount > 0 ? (CustodiaCount / AssinadosCount) : 0; // Custódia vs Assinados
    
    const canvas = document.getElementById('conversionRatesChart');
    const noDataMessage = document.getElementById('ratesNoDataMessage');

    if (ClientesCount === 0 || AssinadosCount === 0) {
        canvas.style.display = 'none';
        noDataMessage.style.display = 'flex';
        if (chartInstances.conversionRatesChart) chartInstances.conversionRatesChart.destroy();
        return;
    }
    
    canvas.style.display = 'block';
    noDataMessage.style.display = 'none';
    
    const labels = [
        `Taxa de Assinatura (Contrato / Total)`,
        `Taxa de Custódia (Custódia / Assinados)`
    ];
    
    const values = [taxaAssinatura * 100, taxaCustodia * 100];
    
    if (chartInstances.conversionRatesChart) chartInstances.conversionRatesChart.destroy(); 

    chartInstances.conversionRatesChart = new Chart(canvas, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Taxa de Conversão',
                data: values,
                backgroundColor: [
                    'var(--cor-principal-b)', 
                    'var(--cor-conversao)'
                ],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: (context) => {
                             return `${context.parsed.y.toFixed(1)}%`;
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100,
                    title: {
                        display: true,
                        text: 'Taxa de Conversão (%)'
                    },
                    ticks: {
                        callback: (value) => value + '%'
                    }
                }
            }
        }
    });
}


// --- FUNÇÃO PRINCIPAL DE CARREGAMENTO E POPULAÇÃO ---
function loadDataAndPopulateDashboard() {
    const data = localStorage.getItem('vindeClientsData');
    
    if (data) {
        try {
            clientsData = JSON.parse(data);
        } catch (e) {
            console.error("Erro ao ler dados do localStorage para o Dashboard:", e);
            clientsData = [];
        }
    } else {
        clientsData = [];
    }

    const kpis = calculateKPIs(clientsData);
    
    // --- POPULAÇÃO DOS KPIS REAIS ---
    document.getElementById('kpiAUMTotal').textContent = formatCurrency(kpis.AUMTotal);
    // Alterado para "Receita Anual Projetada"
    document.getElementById('kpiReceitaMensal').textContent = formatCurrency(kpis.ReceitaAnual);
    document.getElementById('kpiTotalClientes').textContent = kpis.ClientesCount;
    document.getElementById('kpiFeeMedio').textContent = formatPercentage(kpis.FeeMedio);
    document.getElementById('kpiTicketMedio').textContent = formatCurrency(kpis.TicketMedio);
    
    // Atualizações das legendas
    document.getElementById('kpiAUMChange').textContent = `Base total: ${kpis.ClientesCount} clientes.`;
    document.getElementById('kpiReceitaChange').textContent = `Com Fee Médio de ${formatPercentage(kpis.FeeMedio)}`;
    
    // --- RENDERIZA OS NOVOS GRÁFICOS ESTRATÉGICOS ---
    renderAUMCorretoraChart(clientsData);
    renderFeeAumChart(clientsData); 
    renderConversionRatesChart(kpis);

    // Esconde o loader após carregar e calcular
    document.getElementById('loader').style.display = 'none';
    const main = document.getElementById('mainContainer');
    main.style.opacity = '1';
    main.style.transform = 'translateY(0)';
}


// Loader e Inicialização
window.addEventListener('load', () => {
  // Garantir o mesmo tempo de espera do loader do outro arquivo
  setTimeout(loadDataAndPopulateDashboard, 1500); 
});

// Toggle sidebar (CORRIGIDO PARA TRANSITION)
function toggleSidebar() {
  const sidebar = document.getElementById('sidebar');
  const main = document.getElementById('mainContainer');
  sidebar.classList.toggle('closed');
  main.classList.toggle('closed');

  const toggleBtn = document.querySelector('.btn-toggle');
  const isClosed = sidebar.classList.contains('closed');
  
  // Lógica de rotação suave
  toggleBtn.style.transform = isClosed ? "rotate(0deg)" : "rotate(90deg)"; 
}
</script>
</body>
</html>