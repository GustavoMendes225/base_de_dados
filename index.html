<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard Principal - Vinde Investimentos</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<style>

:root {
  /* Cores Base */
  --azul-escuro: #182C4B;
  --verde-claro: #00BFAE;
  --cinza-claro: #F4F6F9;
  --cinza-escuro: #4A4A4A;
  --branco: #FFFFFF;
  --amarelo: #F39C12; /* Assinados Pendentes */
  --vermelho: #E74C3C; /* Leads / Alerta / Menor Fee */
  --verde-secundario: #2ECC71; /* Custódia / Oportunidade / Maior Fee */
  --roxo: #9b59b6; 
  --verde-receita: #4CAF50; 
  
  /* Cores para o Funil de Conversão (AJUSTADAS) */
  --funil-leads: var(--vermelho); 
  --funil-assinou: var(--amarelo); 
  --funil-custodia: var(--verde-secundario); 
  
  /* Cores para o Gráfico de Oportunidade (AJUSTADAS) */
  --oportunidade-destaque: var(--verde-secundario); /* Verde para o maior Fee (Oportunidade) */
  --oportunidade-menor: var(--vermelho); /* Vermelho para o menor Fee (Atenção/Risco) */
}

/* Reset */
* { box-sizing: border-box; font-family: 'Poppins', sans-serif; margin: 0; padding: 0; }
html, body { height: 100%; }

/* Animação do Loader */
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/* Loader */
#loader {
  position: fixed; top:0; left:0; width:100%; height:100%; background: var(--branco);
  display:flex; justify-content:center; align-items:center; flex-direction:column; z-index:2000;
}
.loader-text { margin-top:15px; font-weight:500; color: var(--azul-escuro); }
.loader-icon { 
    width:200px; height:200px; 
    animation: spin 2.0s linear infinite; 
    margin: 20px;
}

/* Navbar */
.navbar {
  height:60px; background-color: var(--azul-escuro); color: var(--branco);
  display:flex; justify-content:space-between; align-items:center; padding:0 20px;
  position:fixed; width:100%; top:0; z-index:1000; box-shadow:0 2px 5px rgba(0,0,0,0.1);
  font-weight: 600;
}
.navbar .btn-toggle {
  background-color: var(--azul-escuro); border:none; padding:8px 15px; color: var(--branco);
  border-radius:5px; cursor:pointer; font-size:24px; transition:0.3s;
}
.navbar .btn-sair {
  background-color: var(--azul-escuro); border:solid 1px; padding:8px 15px; color: var(--branco);
  border-radius:5px; cursor:pointer; font-size:12px; transition:0.3s;
}
.navbar .btn-sair:hover, .navbar .btn-toggle:hover { opacity:0.9; }
.navbar .btn-toggle { 
    display:flex; align-items:center; justify-content:center; 
    transition: transform 0.3s ease;
}
.navbar-logo {
  height: 60px; /* Ajusta a altura da imagem para caber no navbar */
  margin: 0 auto; /* Centraliza a imagem na horizontal */
  object-fit: contain; /* Garante que a imagem não fique esticada */
}

/* Sidebar */
.sidebar {
  width:250px; background-color: var(--cinza-claro); padding:20px;
  position:fixed; top:60px; left:0; height:calc(100% - 60px); overflow-y:auto;
  box-shadow:2px 0 12px rgba(0,0,0,0.2);
  transition:left 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  z-index:999;
}
.sidebar-section { margin-bottom:25px; }
.sidebar-section h4 { 
    font-size:13px; text-transform:uppercase; color: var(--cinza-escuro); 
    margin-bottom:10px; letter-spacing:0.5px; 
}
.sidebar a {
  display:flex; align-items:center; text-decoration:none; color: var(--azul-escuro);
  padding:10px; border-radius:5px; margin-bottom:5px; font-weight:500;
  transition: all 0.3s ease, box-shadow 0.3s ease, transform 0.3s ease;
  position: relative;
}
.sidebar a .icon { margin-right:10px; transition: transform 0.3s ease; }
.sidebar a:hover {
  background-color: var(--verde-claro); color: var(--branco);
  transform: translateX(8px); box-shadow: 2px 4px 10px rgba(0,0,0,0.15);
}
.sidebar a.active {
  background-color: var(--azul-escuro); color: var(--branco);
  font-weight:600; border-left:4px solid var(--verde-claro);
  box-shadow: 2px 4px 10px rgba(0,0,0,0.15); 
  transform: translateX(0);
}
.sidebar.closed { left:-260px; }


/* Main container */
.main-container {
  margin-left:250px; 
  padding:80px 20px 80px 20px;
  min-height: calc(100vh - 60px); 
  background-color: var(--cinza-claro); 
  transition: margin-left 0.4s cubic-bezier(0.4, 0, 0.2, 1), transform 0.5s, opacity 0.5s;
  opacity:0; transform:translateY(20px);
}
/* Sidebar recolhida */
.main-container.closed { margin-left:0; }

/* Content Layout (Dashboard Grid) */
.dashboard-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}
/* KPI Cards */
.kpi-card { 
    background-color: var(--branco); padding: 20px; border-radius: 8px; 
    box-shadow: 0 4px 12px rgba(0,0,0,0.08); border-left: 5px solid var(--azul-escuro); 
    min-height: 120px;
}
.kpi-card-title { font-size: 14px; color: var(--cinza-escuro); text-transform: uppercase; margin-bottom: 5px; }
.kpi-card-value { font-size: 28px; font-weight: 700; color: var(--azul-escuro); }
.kpi-card-change { font-size: 12px; margin-top: 5px; font-weight: 500; }
.positive { color: var(--verde-secundario); }
.neutral { color: var(--amarelo); }

/* Chart Area */
.chart-area {
    background-color: var(--branco);
    padding: 30px;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    text-align: center;
    margin-bottom: 20px; 
}
.chart-area h2 {
    color: var(--azul-escuro);
    margin-bottom: 20px;
    border-bottom: 2px solid var(--verde-claro);
    padding-bottom: 10px;
    font-size: 20px;
}
.chart-placeholder {
    height: 400px;
    background-color: var(--cinza-claro);
    border: 1px dashed #ccc;
    display: flex;
    justify-content: center;
    align-items: center;
    color: var(--cinza-escuro);
    font-style: italic;
    border-radius: 5px;
    font-weight: 600;
}

/* Layout para os gráficos em linha (Funil + Status) */
.chart-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}
.chart-row .chart-area {
    margin-bottom: 0;
}

/* Área de Filtros */
.filter-area {
    background-color: var(--branco);
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    margin-bottom: 30px;
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: 20px;
    border: 1px solid var(--cinza-claro);
}

.filter-area h4 {
    color: var(--azul-escuro);
    font-size: 16px;
    margin: 0;
}

.filter-area select {
    padding: 10px;
    border-radius: 5px;
    border: 1px solid #ddd;
    font-size: 14px;
    min-width: 180px;
    flex-grow: 1;
    cursor: pointer;
    background-color: var(--cinza-claro);
}

.filtered-count {
    font-weight: 600;
    color: var(--verde-secundario);
    margin-left: auto;
    flex-shrink: 0;
}

/* Footer fixo */
.footer {
  position: fixed; bottom:0; width:100%; height:60px;
  text-align:center; padding:20px 0; background-color: var(--cinza-claro); border-top:1px solid #ddd;
  z-index: 990;
}

/* Responsividade */
@media screen and (max-width:768px){
  .sidebar { left:-260px; }
  .sidebar.open { left:0; }
  .main-container { margin-left:0; padding-bottom:80px; padding-top: 80px; }
  .dashboard-grid, .chart-row { grid-template-columns: 1fr; }
  .filter-area { flex-direction: column; align-items: stretch; }
  .filtered-count { margin-left: 0; margin-top: 10px; text-align: center; }
}



</style>
</head>

<body>
<div id="loader">
  <img class="loader-icon" src="./img/B2B-4.png"  alt="">
  <div class="loader-text">Carregando Dashboard...</div>
</div>

<div class="navbar">
  <button class="btn-toggle" onclick="toggleSidebar()">☰</button>
  
  <img src="./img/B2B-3.png" alt="Logo Vinde" class="navbar-logo"> 
  
</div>

<div class="sidebar" id="sidebar">
  <div class="sidebar-section">
    <h4>Operações</h4>
    <a href="#" class="active"><span class="icon">></span> Dashboard Principal</a>
    <a href="base_de_dados.html"><span class="icon">></span> Base de Dados</a>
  </div>
</div>

<div class="main-container" id="mainContainer">
    <h1>Visão Estratégica & Oportunidades</h1>
    <p style="margin-bottom: 20px; color: var(--cinza-escuro);">Insights acionáveis sobre concentração de risco, potencial de receita e taxas de conversão da base.</p>

    <div class="filter-area">
        <h4>Filtros de Segmentação:</h4>
        
        <select id="filterCorretora" onchange="applyFilters()">
            <option value="Todos">Corretora (Todas)</option>
        </select>
        
        <select id="filterStatus" onchange="applyFilters()">
            <option value="Todos">Status de Conversão (Todos)</option>
            <option value="CustodiaPendentes">Alerta: Assinou, Custódia Pendente</option>
            <option value="SemAssinatura">Foco Vendas: Sem Contrato Assinado</option>
        </select>
        
        <span id="filteredCount" class="filtered-count">0 Clientes Filtrados</span>
    </div>

    <div class="dashboard-grid">
        
        <div class="kpi-card">
            <div class="kpi-card-title">AUM TOTAL (CUSTÓDIA)</div>
            <div class="kpi-card-value" id="kpiAUMTotal">R$ 0,00</div>
            <div class="kpi-card-change positive" id="kpiAUMChange">Base total: 0 clientes.</div>
        </div>
        
        <div class="kpi-card" style="border-left-color: var(--verde-receita);">
            <div class="kpi-card-title">RECEITA ANUAL PROJETADA</div>
            <div class="kpi-card-value" id="kpiReceitaAnual">R$ 0,00</div>
            <div class="kpi-card-change positive" id="kpiReceitaChange">Com Fee Médio de 0.00%.</div>
        </div>
        
        <div class="kpi-card" style="border-left-color: var(--verde-claro);">
            <div class="kpi-card-title">TOTAL DE CLIENTES</div>
            <div class="kpi-card-value" id="kpiTotalClientes">0</div>
            <div class="kpi-card-change positive" id="kpiClientesChange">Assinados: 0, Custódia: 0</div>
        </div>

        <div class="kpi-card" style="border-left-color: var(--amarelo);">
            <div class="kpi-card-title">FEE MÉDIO PONDERADO</div>
            <div class="kpi-card-value" id="kpiFeeMedio">0.00%</div>
            <div class="kpi-card-change neutral" id="kpiFeeChange">Baseado no AUM filtrado.</div>
        </div>

        <div class="kpi-card" style="border-left-color: var(--roxo);">
            <div class="kpi-card-title">TICKET MÉDIO POR CLIENTE</div>
            <div class="kpi-card-value" id="kpiTicketMedio">R$ 0,00</div>
            <div class="kpi-card-change neutral" id="kpiTicketChange">Base para otimização de serviço.</div>
        </div>
        
        </div>

    <div class="chart-area">
        <h2> Análise de Risco de Concentração (AUM por Corretora)</h2>
        <div style="max-width: 450px; margin: 0 auto; height: 400px; display: flex; align-items: center; justify-content: center;">
            <canvas id="aumCorretoraChart"></canvas>
            <div id="corretoraNoDataMessage" class="chart-placeholder" style="display: none; height: 100%; width: 100%;">
                 <p>Sem dados de AUM ou Corretora.</p>
            </div>
        </div>
    </div>
    
    <div class="chart-row">
        <div class="chart-area">
            <h2> Oportunidade: Fee Médio por Faixa de AUM</h2>
             <div style="max-width: 100%; margin: 0 auto; height: 400px; display: flex; align-items: center; justify-content: center;">
                <canvas id="feeAumChart"></canvas>
                <div id="feeNoDataMessage" class="chart-placeholder" style="display: none; height: 100%; width: 100%;">
                    <p>Sem dados de Fee ou AUM para análise de oportunidade.</p>
                </div>
            </div>
        </div>
        
        <div class="chart-area">
            <h2> Funil de Conversão (Assinatura para Custódia)</h2>
            <div style="max-width: 100%; margin: 0 auto; height: 400px; display: flex; align-items: center; justify-content: center;">
                <canvas id="conversionFunnelChart"></canvas>
                <div id="funnelNoDataMessage" class="chart-placeholder" style="display: none; height: 100%; width: 100%;">
                    <p>Sem dados de Clientes para Funil (Total, Assinados, Custódia).</p>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="footer">© 2025 Vinde Investimentos</div>

<script>
let clientsData = [];
let chartInstances = {}; // Objeto para gerenciar todas as instâncias de gráficos

// --- VARIÁVEIS JAVASCRIPT LENDO AS CORES CSS PARA OS GRÁFICOS ---
// Esta é a correção para o Chart.js conseguir ler as variáveis CSS dinâmicas.
const style = getComputedStyle(document.body);
const AZUL_ESCURO = style.getPropertyValue('--azul-escuro').trim();

// Cores Funil e Oportunidade
const COR_OPORTUNIDADE_MAIOR = style.getPropertyValue('--oportunidade-destaque').trim();
const COR_OPORTUNIDADE_MENOR = style.getPropertyValue('--oportunidade-menor').trim();
const COR_FUNIL_CUSTODIA = style.getPropertyValue('--funil-custodia').trim();
const COR_FUNIL_ASSINOU = style.getPropertyValue('--funil-assinou').trim();
const COR_FUNIL_LEADS = style.getPropertyValue('--funil-leads').trim();


// --- MAPAS DE CHAVES DO EXCEL ---
const EXCEL_KEYS = {
    AUM: 'AUM',
    FEE: 'FEE',
    CORRETORA: 'Corretora',
    ASSINOU_CONTRATO: 'Assinou Contrato?',
    SUBIU_CORRETORA: 'Subiu Cliente Corretora?',
    CODIGO_CONTA: 'Código da conta'
};

const formatCurrency = (value) => {
    const num = parseFloat(value) || 0;
    return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(num);
};

const formatPercentage = (value) => {
    const num = parseFloat(value) || 0;
    return (num * 100).toFixed(2) + '%';
};

// --- FUNÇÃO CENTRAL DE CÁLCULO DE KPIS (CORREÇÃO DE NORMALIZAÇÃO DO FEE) ---
function calculateKPIs(data) {
    if (data.length === 0) {
        return { AUMTotal: 0, ReceitaAnual: 0, FeeMedio: 0, TicketMedio: 0, ClientesCount: 0, AssinadosCount: 0, CustodiaCount: 0 };
    }
    
    let totalAUMCustodia = 0;
    let totalFeeAnual = 0; 
    let clientesCount = 0;
    let assinadosCount = 0;
    let custodiaCount = 0;
    
    data.forEach(client => {
        const aum = parseFloat(client[EXCEL_KEYS.AUM]) || 0;
        
        let feeValue = String(client[EXCEL_KEYS.FEE] || '0').replace('%', '').trim().replace(',', '.');
        let fee = parseFloat(feeValue) || 0;
        
        // CORREÇÃO FINAL: Presume que qualquer valor >= 0.05 ou > 1 é uma porcentagem não convertida e divide por 100.
        // Ex: 0.75 (75%) -> 0.0075. 1.2 (1.2%) -> 0.012
        if (fee >= 0.05 || fee > 1) { 
            fee = fee / 100;
        }

        if (aum > 0) {
            totalAUMCustodia += aum;
            totalFeeAnual += aum * fee; 
        }
        
        clientesCount++;
        
        if (String(client[EXCEL_KEYS.ASSINOU_CONTRATO]).toLowerCase().includes('sim')) {
            assinadosCount++;
        }
        if (String(client[EXCEL_KEYS.SUBIU_CORRETORA]).toLowerCase().includes('sim')) {
             custodiaCount++;
        }
    });

    const feeMedioPonderado = totalAUMCustodia > 0 ? (totalFeeAnual / totalAUMCustodia) : 0;
    const ticketMedio = clientesCount > 0 ? (totalAUMCustodia / clientesCount) : 0;
    
    return {
        AUMTotal: totalAUMCustodia, 
        ReceitaAnual: totalFeeAnual, 
        FeeMedio: feeMedioPonderado, 
        TicketMedio: ticketMedio, 
        ClientesCount: clientesCount, 
        AssinadosCount: assinadosCount,
        CustodiaCount: custodiaCount
    };
}

// --- POPULAÇÃO DOS KPIS NA TELA ---
function populateKPIs(kpis) {
    document.getElementById('kpiAUMTotal').textContent = formatCurrency(kpis.AUMTotal);
    document.getElementById('kpiReceitaAnual').textContent = formatCurrency(kpis.ReceitaAnual);
    
    document.getElementById('kpiTotalClientes').textContent = kpis.ClientesCount;
    document.getElementById('kpiFeeMedio').textContent = formatPercentage(kpis.FeeMedio); 
    
    document.getElementById('kpiTicketMedio').textContent = formatCurrency(kpis.TicketMedio);
    
    // Atualizações das legendas
    document.getElementById('kpiAUMChange').textContent = `Base total: ${kpis.ClientesCount} clientes.`;
    document.getElementById('kpiReceitaChange').textContent = `Com Fee Médio de ${formatPercentage(kpis.FeeMedio)}`;
    document.getElementById('kpiClientesChange').textContent = `Assinados: ${kpis.AssinadosCount}, Custódia: ${kpis.CustodiaCount}`;
}

// --- FUNÇÕES DE FILTRAGEM (MANTIDAS) ---
function populateFilters(data) {
    const corretoras = new Set();
    data.forEach(client => {
        const c = String(client[EXCEL_KEYS.CORRETORA] || '').trim();
        if (c) corretoras.add(c);
    });

    const selectCorretora = document.getElementById('filterCorretora');
    const selectedCorretora = selectCorretora.value; 

    selectCorretora.innerHTML = '<option value="Todos">Corretora (Todas)</option>';

    [...corretoras].sort().forEach(corretora => {
        const option = document.createElement('option');
        option.value = corretora;
        option.textContent = corretora;
        selectCorretora.appendChild(option);
    });
    selectCorretora.value = selectedCorretora || 'Todos'; 
}

function applyFilters() {
    const corretoraFilter = document.getElementById('filterCorretora').value;
    const statusFilter = document.getElementById('filterStatus').value;
    let filteredData = [...clientsData];

    // 1. Filtrar por Corretora
    if (corretoraFilter !== 'Todos') {
        filteredData = filteredData.filter(client => 
            String(client[EXCEL_KEYS.CORRETORA] || '').trim() === corretoraFilter
        );
    }

    // 2. Filtrar por Status de Conversão (Funil)
    if (statusFilter !== 'Todos') {
        filteredData = filteredData.filter(client => {
            const assinou = String(client[EXCEL_KEYS.ASSINOU_CONTRATO]).toLowerCase().includes('sim');
            const subiuCustodia = String(client[EXCEL_KEYS.SUBIU_CORRETORA]).toLowerCase().includes('sim');

            if (statusFilter === 'CustodiaPendentes') {
                return assinou && !subiuCustodia; 
            } else if (statusFilter === 'SemAssinatura') {
                return !assinou; 
            }
            return true;
        });
    }
    
    document.getElementById('filteredCount').textContent = `${filteredData.length} Clientes Filtrados`;
    
    const kpis = calculateKPIs(filteredData);
    populateKPIs(kpis);
    renderAUMCorretoraChart(filteredData); 
    renderFeeAumChart(filteredData); 
    renderConversionFunnelChart(kpis); 
}

// --- GRÁFICO 1: AUM POR CORRETORA (RISCO DE CONCENTRAÇÃO) ---
function renderAUMCorretoraChart(data) {
    const corretoraData = {};
    data.forEach(client => {
        const aum = parseFloat(client[EXCEL_KEYS.AUM]) || 0;
        if (aum === 0) return;
        const corretora = String(client[EXCEL_KEYS.CORRETORA] || 'Não Informada').trim();
        corretoraData[corretora] = (corretoraData[corretora] || 0) + aum;
    });

    const labels = Object.keys(corretoraData).filter(key => corretoraData[key] > 0);
    const values = labels.map(key => corretoraData[key]);
    
    const canvas = document.getElementById('aumCorretoraChart');
    const noDataMessage = document.getElementById('corretoraNoDataMessage');
    
    if (values.length === 0) {
        canvas.style.display = 'none';
        noDataMessage.style.display = 'flex';
        if (chartInstances.aumCorretoraChart) chartInstances.aumCorretoraChart.destroy();
        return;
    }

    canvas.style.display = 'block';
    noDataMessage.style.display = 'none';

    if (chartInstances.aumCorretoraChart) chartInstances.aumCorretoraChart.destroy();
    
    const newColors = [
        '#1E40AF', // Azul Forte
        '#047857', // Verde Escuro
        '#FBBF24', // Amarelo
        '#7C3AED', // Roxo
        '#DC2626', // Vermelho
        '#F97316', // Laranja
        '#57534F', // Marrom
    ];

    chartInstances.aumCorretoraChart = new Chart(canvas, {
        type: 'pie',
        data: {
            labels: labels,
            datasets: [{
                data: values,
                backgroundColor: newColors.slice(0, labels.length),
                hoverOffset: 8
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'right' },
                tooltip: {
                    callbacks: {
                        label: (context) => {
                            let label = context.label || '';
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = (context.parsed / total * 100).toFixed(1);
                            label += ': ' + formatCurrency(context.parsed) + ` (${percentage}%)`;
                            return label;
                        }
                    }
                },
            }
        }
    });
}


// --- GRÁFICO 2: FEE MÉDIO POR FAIXA DE AUM (OPORTUNIDADE - CORES AGORA EM JS) ---
function renderFeeAumChart(data) {
    const FAIIXAS = {
        '0 - 50K': { min: 0, max: 50000, AUMTotal: 0, FeeTotal: 0 },
        '50K - 250K': { min: 50001, max: 250000, AUMTotal: 0, FeeTotal: 0 },
        '250K - 1M': { min: 250001, max: 1000000, AUMTotal: 0, FeeTotal: 0 },
        '1M+': { min: 1000001, max: Infinity, AUMTotal: 0, FeeTotal: 0 }
    };

    let totalValid = 0;

    data.forEach(client => {
        const aum = parseFloat(client[EXCEL_KEYS.AUM]) || 0;
        
        let feeValue = String(client[EXCEL_KEYS.FEE] || '0').replace('%', '').trim().replace(',', '.');
        let fee = parseFloat(feeValue) || 0;
        
        if (fee >= 0.05 || fee > 1) { 
             fee = fee / 100;
        }

        if (aum === 0 || fee === 0) return;
        totalValid++;
        const feeAnual = aum * fee;

        for (const faixa in FAIIXAS) {
            if (aum >= FAIIXAS[faixa].min && aum <= FAIIXAS[faixa].max) {
                FAIIXAS[faixa].AUMTotal += aum;
                FAIIXAS[faixa].FeeTotal += feeAnual;
                break;
            }
        }
    });

    const labels = Object.keys(FAIIXAS);
    const feeMedios = labels.map(faixa => {
        const f = FAIIXAS[faixa];
        return f.AUMTotal > 0 ? (f.FeeTotal / f.AUMTotal) : 0;
    });

    const canvas = document.getElementById('feeAumChart');
    const noDataMessage = document.getElementById('feeNoDataMessage');
    
    if (totalValid === 0) {
        canvas.style.display = 'none';
        noDataMessage.style.display = 'flex';
        if (chartInstances.feeAumChart) chartInstances.feeAumChart.destroy();
        return;
    }

    canvas.style.display = 'block';
    noDataMessage.style.display = 'none';
    
    if (chartInstances.feeAumChart) chartInstances.feeAumChart.destroy();

    chartInstances.feeAumChart = new Chart(canvas, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Fee Médio Ponderado',
                data: feeMedios.map(f => f * 100), // Exibir em porcentagem
                backgroundColor: (context) => {
                    const data = context.chart.data.datasets[0].data.filter(val => val > 0);
                    if (data.length === 0) return AZUL_ESCURO;
                    
                    const maxFee = Math.max(...data); 
                    const minFee = Math.min(...data);
                    const currentFee = context.parsed.y;
                    
                    // USANDO AS VARIÁVEIS JS AGORA
                    if (currentFee > 0 && currentFee === maxFee) {
                        return COR_OPORTUNIDADE_MAIOR; // Verde
                    } else if (currentFee > 0 && currentFee === minFee) {
                        return COR_OPORTUNIDADE_MENOR; // Vermelho
                    } else {
                        return AZUL_ESCURO; // Padrão Azul
                    }
                }
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: (context) => {
                             return `Fee Médio: ${context.parsed.y.toFixed(2)}%`;
                        }
                    }
                },
            },
            scales: {
                y: {
                    beginAtZero: true,
                    title: { display: true, text: 'Fee Médio (%)' },
                    ticks: { callback: (value) => value + '%' }
                }
            }
        }
    });
}

// --- GRÁFICO 3: FUNIL DE CONVERSÃO (CORES AGORA EM JS) ---
function renderConversionFunnelChart(kpis) {
    const { ClientesCount, AssinadosCount, CustodiaCount } = kpis;
    
    const canvas = document.getElementById('conversionFunnelChart');
    const noDataMessage = document.getElementById('funnelNoDataMessage');

    if (ClientesCount === 0) {
        canvas.style.display = 'none';
        noDataMessage.style.display = 'flex';
        if (chartInstances.conversionFunnelChart) chartInstances.conversionFunnelChart.destroy();
        return;
    }
    
    canvas.style.display = 'block';
    noDataMessage.style.display = 'none';
    
    const leads = ClientesCount - AssinadosCount;
    const pendentes = AssinadosCount - CustodiaCount;
    const custodia = CustodiaCount;

    const labels = [
        `3. Custódia (${custodia})`,
        `2. Assinados Pendentes (${pendentes})`,
        `1. Leads (Não Assinaram: ${leads})`
    ];
    
    const values = [
        custodia,
        pendentes, 
        leads 
    ];
    
    // USANDO AS VARIÁVEIS JS AGORA
    const backgroundColors = [
        COR_FUNIL_CUSTODIA, 
        COR_FUNIL_ASSINOU, 
        COR_FUNIL_LEADS 
    ];

    if (chartInstances.conversionFunnelChart) chartInstances.conversionFunnelChart.destroy(); 

    chartInstances.conversionFunnelChart = new Chart(canvas, {
        type: 'doughnut',
        data: {
            // Invertendo a ordem para que o "Sucesso" (Custódia) comece no topo visualmente
            labels: labels.reverse(), 
            datasets: [{
                data: values.reverse(),
                backgroundColor: backgroundColors.reverse(),
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: '50%', 
            plugins: {
                legend: { position: 'bottom' },
                title: {
                    display: true,
                    text: `Total de Clientes: ${ClientesCount}`,
                    font: { size: 16 }
                },
                tooltip: {
                    callbacks: {
                        label: (context) => {
                             const total = context.dataset.data.reduce((a, b) => a + b, 0);
                             const percentage = (context.parsed / total * 100).toFixed(1);
                             return `${context.label}: ${percentage}%`;
                        }
                    }
                }
            }
        }
    });
}


// --- FUNÇÃO PRINCIPAL DE CARREGAMENTO E POPULAÇÃO (MODIFICADA) ---
function loadDataAndPopulateDashboard() {
    const data = localStorage.getItem('vindeClientsData');
    
    if (data) {
        try {
            clientsData = JSON.parse(data);
        } catch (e) {
            console.error("Erro ao ler dados do localStorage para o Dashboard:", e);
            // Em caso de erro, usa array vazio.
            clientsData = []; 
        }
    } else {
        // Se não há dados no localStorage, inicializa com array vazio.
        clientsData = [];
    }
    
    // A partir daqui, clientsData é garantidamente um array (vazio ou com dados).
    
    populateFilters(clientsData);
    applyFilters(); 

    document.getElementById('loader').style.display = 'none';
    const main = document.getElementById('mainContainer');
    main.style.opacity = '1';
    main.style.transform = 'translateY(0)';
}


// Loader e Inicialização
window.addEventListener('load', () => {
  setTimeout(loadDataAndPopulateDashboard, 1000); 
});

// Toggle sidebar 
function toggleSidebar() {
  const sidebar = document.getElementById('sidebar');
  const main = document.getElementById('mainContainer');
  sidebar.classList.toggle('closed');
  main.classList.toggle('closed');

  const toggleBtn = document.querySelector('.btn-toggle');
  const isClosed = sidebar.classList.contains('closed');
  
  toggleBtn.style.transform = isClosed ? "rotate(0deg)" : "rotate(90deg)"; 
}
</script>
</body>
</html>
